# bnminer

External Blocknet miner with a pluggable backend architecture.

Current status:
- CPU backend: implemented (Argon2id, consensus-compatible params).
- NVIDIA backend: scaffolded interface only (not implemented yet).
- Runtime architecture: supports multiple backends in one process with persistent workers, configurable bounded backend event queues, coalesced tip notifications (deduped across SSE reconnects), and optional strict quiesce barriers for round-accurate hash accounting.
  - Runtime is split into `src/miner/{mining,bench,scheduler,stats}.rs` to keep orchestration, benchmarking, nonce scheduling, and telemetry isolated for faster iteration.

## Test

```bash
cd bnminer
cargo test
```

## Build

```bash
cd bnminer
cargo build --release
```

## Run

`bnminer` needs the authenticated API token generated by `blocknet --api`.

If your daemon data dir is `./data` (default), this works out of the box:

```bash
./target/release/bnminer --api-url http://127.0.0.1:8332 --threads 1
```

If your cookie file is elsewhere:

```bash
./target/release/bnminer --api-url http://127.0.0.1:8332 --cookie /path/to/data/api.cookie
```

Or pass token directly:

```bash
./target/release/bnminer --api-url http://127.0.0.1:8332 --token <hex_token>
```

If daemon mode starts without a wallet loaded, `bnminer` now auto-loads wallet on first template request.
Password sources (in order): `--wallet-password`, `--wallet-password-file`, `BNMINER_WALLET_PASSWORD`, interactive prompt.

```bash
./target/release/bnminer --api-url http://127.0.0.1:8332 --wallet-password-file /path/to/wallet.pass
```

Select multiple backends (comma-separated or repeated flag). Unavailable backends are skipped:

```bash
./target/release/bnminer --backend cpu,nvidia --threads 1
```

## Notes

- Each CPU thread needs roughly 2GB RAM due to Argon2id parameters.
- By default, bnminer refuses to start if configured CPU lanes exceed detected system RAM. Override with `--allow-oversubscribe` if needed.
- The miner fetches block templates from `/api/mining/blocktemplate` and submits solved blocks to `/api/mining/submitblock` using compact `{template_id, nonce}` payloads when available.
- If `/api/mining/blocktemplate` reports `no wallet loaded`, the miner automatically calls `/api/wallet/load` and retries.
- The miner listens to `/api/events` and refreshes work immediately on `new_block` events (disable with `--disable-sse`).
  - SSE events with heights older than the current template tip are ignored to avoid historical replay storms.
- Runtime tuning knobs for performance iteration:
  - `--backend-event-capacity` (default `1024`) controls bounded backend event queue size.
  - `--hash-poll-ms` (default `200`) controls backend hash counter polling cadence.
  - `--relaxed-accounting` disables per-round quiesce barriers (higher throughput, less exact round accounting).
- A backend runtime fault quarantines only that backend; mining continues on remaining active backends when possible.
- This miner is intentionally external so consensus-critical validation remains in the daemon.
- Nonce space is reserved deterministically per epoch via `--nonce-iters-per-lane` (default `2^36` iterations per lane), avoiding overlap between refresh rounds without relying on sampled hash counters.

## Performance Benchmarking

Run deterministic local benchmarking (no API connection needed):

- `--bench-kind kernel`: hash kernel only (single backend).
- `--bench-kind backend`: persistent backend workers (steady-state throughput).
- `--bench-kind end-to-end`: includes backend start/stop per round.

```bash
cd bnminer
cargo run --release -- --bench --bench-kind backend --backend cpu --threads 1 --bench-secs 20 --bench-rounds 3 --bench-output bench.json
```

Compare against a previous baseline:

```bash
cargo run --release -- --bench --bench-kind backend --backend cpu --threads 1 --bench-secs 20 --bench-rounds 3 --bench-baseline bench.json
```
