# seine

`seine` is an external Blocknet miner with a pluggable backend architecture.

Current status:
- CPU backend: implemented (Argon2id, consensus-compatible params).
- NVIDIA backend: scaffolded interface only (not implemented yet).
- Runtime architecture: supports multiple backends in one process with persistent workers, configurable bounded backend event queues, coalesced tip notifications (deduped across SSE reconnects), template prefetch overlap to reduce round-boundary idle, and optional strict quiesce barriers for round-accurate hash accounting.
  - Runtime assigns disjoint nonce chunks per backend per round (backend-local scheduling inside each chunk) so CPU and future GPU implementations can iterate independently without nonce overlap.
  - Runtime is split into `src/miner/{mining,bench,scheduler,stats}.rs` to keep orchestration, benchmarking, nonce scheduling, and telemetry isolated for faster iteration.

## Test

```bash
cd seine
cargo test
```

## Build

```bash
cd seine
cargo build --release
```

## Run

`seine` needs the authenticated API token generated by `blocknet --api`.

If your daemon data dir is `./data` (default), this works out of the box:

```bash
./target/release/seine --api-url http://127.0.0.1:8332 --threads 1
```

If your cookie file is elsewhere:

```bash
./target/release/seine --api-url http://127.0.0.1:8332 --cookie /path/to/data/api.cookie
```

Or pass token directly:

```bash
./target/release/seine --api-url http://127.0.0.1:8332 --token <hex_token>
```

If daemon mode starts without a wallet loaded, `seine` auto-loads wallet on first template request.
Password sources (in order): `--wallet-password`, `--wallet-password-file`, `SEINE_WALLET_PASSWORD`, interactive prompt.

```bash
./target/release/seine --api-url http://127.0.0.1:8332 --wallet-password-file /path/to/wallet.pass
```

Select multiple backends (comma-separated or repeated flag). Unavailable backends are skipped:

```bash
./target/release/seine --backend cpu,nvidia --threads 1
```

Run headless/plain logs (no fullscreen TUI):

```bash
./target/release/seine --ui plain --backend cpu --threads 1
```

## Notes

- Each CPU thread needs roughly 2GB RAM due to Argon2id parameters.
- By default, seine refuses to start if configured CPU lanes exceed detected system RAM. Override with `--allow-oversubscribe` if needed.
- The miner fetches block templates from `/api/mining/blocktemplate` and submits solved blocks to `/api/mining/submitblock` using compact `{template_id, nonce}` payloads when available.
- If `/api/mining/blocktemplate` reports `no wallet loaded`, the miner automatically calls `/api/wallet/load` and retries.
- The miner listens to `/api/events` and refreshes work immediately on `new_block` events (disable with `--disable-sse`).
  - SSE events with heights older than the current template tip are ignored to avoid historical replay storms.
  - Same-height competing hash events are coalesced by default; pass `--refresh-on-same-height` for aggressive tip freshness.
- Runtime tuning knobs for performance iteration:
  - `--backend-event-capacity` (default `1024`) controls bounded backend event queue size.
  - `--hash-poll-ms` (default `200`) controls backend hash counter polling cadence.
  - `--stats-secs` (default `10`) controls periodic stats log emission cadence.
  - `--request-timeout-secs` (default `10`) controls JSON API request timeout for template/submit/wallet calls.
  - `--events-stream-timeout-secs` (default `10`) controls SSE connect timeout per attempt (stream itself is long-lived).
  - `--cpu-affinity` (`auto` or `off`) controls CPU worker pinning policy for better repeatability on NUMA/SMT hosts.
  - `--ui` (`auto`, `tui`, `plain`) controls rendering mode. `auto` enables TUI only when stdout/stderr are terminals.
  - `--relaxed-accounting` disables per-round quiesce barriers (higher throughput, less exact round accounting).
  - `--refresh-on-same-height` forces immediate refresh on same-height `new_block` hash changes.
- A backend runtime fault quarantines only that backend; mining continues on remaining active backends when possible.
- This miner is intentionally external so consensus-critical validation remains in the daemon.
- Nonce space is reserved deterministically per epoch via `--nonce-iters-per-lane` (default `2^36` iterations per lane), avoiding overlap between refresh rounds without relying on sampled hash counters.
  - The runtime logs backend preemption granularity on startup so strict round-accounting fence behavior is visible (`per-hash`, `every N hashes`, or `unknown`).

## Performance Benchmarking

Run deterministic local benchmarking (no API connection needed):

- `--bench-kind kernel`: hash kernel only (single backend).
- `--bench-kind backend`: persistent backend workers (steady-state throughput).
- `--bench-kind end-to-end`: includes backend start/stop per round.
- Worker benchmarks always apply a round-end measurement fence so round H/s is comparable across strict/relaxed accounting modes.

```bash
cd seine
cargo run --release -- --bench --bench-kind backend --backend cpu --threads 1 --bench-secs 20 --bench-rounds 3 --bench-output bench.json
```

Compare against a previous baseline:

```bash
cargo run --release -- --bench --bench-kind backend --backend cpu --threads 1 --bench-secs 20 --bench-rounds 3 --bench-baseline bench.json
```

Fail CI on regression versus baseline (example: fail below `-5%`):

```bash
cargo run --release -- --bench --bench-kind backend --backend cpu --threads 1 --bench-secs 20 --bench-rounds 3 --bench-baseline bench.json --bench-fail-below-pct 5
```
